<html>
    <head>
        <title>push2-python simulator</title>
        <style>
            .button {
                width: 51px;
                height: 51px;
                border: 1px solid black;
                margin: 2px;
                display: inline-block;
            }

            .pad {
                width: 64px;
                height: 51px;
                border: 1px solid black;
                margin: 2px;
                display: inline-block;
            }

            .separator {
                width: 10px;
                height: 51px;
                display: inline-block;
            }

            #display {
                width: 554px;
                height: 92px;
                margin: 2px;
                border: 1px solid black;
            }

            #displayImg {
                height: 100%;
                width: 100%;
            }

        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
        <script type="text/javascript" charset="utf-8">
            var socket = io();
            
            socket.on('connect', () => {
                socket.emit('my event', {data: 'I\'m connected!'});
            });
            
            socket.on('setElementColor', (data) => {
                var element = document.getElementById(data.midiTrigger);
                if (element !== null){
                    if (element.dataset.rgb){
                        element.style.backgroundColor = 'rgb(' + data.rgb[0] + ',' + data.rgb[1] + ',' + data.rgb[2] + ')';
                    } else {
                        element.style.backgroundColor = 'rgb(' + data.bwRgb[0] + ',' + data.bwRgb[1] + ',' + data.bwRgb[2] + ')';
                    }
                }
            });

            socket.on('setDisplay', (data) => {
                var element = document.getElementById("displayImg");
                element.src = data.base64Image;
                console.log("hey")
            });

            function createSeparator(n) {
                var element = document.createElement('div');
                element.classList.add('separator');
                return element;
            }

            function createPad(i, j) {
                var element = document.createElement('div');
                element.classList.add('pad');
                element.dataset.rgb = true;
                element.dataset.midiTrigger = 'nn' + ((92 + j) - i * 8).toString();
                element.id = element.dataset.midiTrigger;
                element.title = element.dataset.midiTrigger;
                element.addEventListener('mousedown', () => {
                    socket.emit('padPressed', element.dataset.midiTrigger);
                });
                element.addEventListener('mouseup', () => {
                    socket.emit('padReleased', element.dataset.midiTrigger);
                });
                return element;
            }

            function createRgbButton(i){
                var element = document.createElement('div');
                element.classList.add('button');
                element.dataset.rgb = true;
                element.dataset.midiTrigger = 'cc' + (43 - i).toString();
                element.id = element.dataset.midiTrigger;
                element.title = element.dataset.midiTrigger;
                element.addEventListener('mousedown', () => {
                    socket.emit('buttonPressed', element.dataset.midiTrigger);
                });
                element.addEventListener('mouseup', () => {
                    socket.emit('buttonReleased', element.dataset.midiTrigger);
                });
                return element;
            }

            function build_ui() {
                var uiWrapper = document.getElementById('uiWrapper');

                // Pads and scene trigger buttons
                for (var i=0; i<8; i++){
                    var padsRow = document.createElement('div');
                    padsRow.classList.add('padsRow');
                    for (var j=0; j<9; j++){
                        if (j<8){
                            padsRow.appendChild(createPad(i , j));
                        } else {
                            padsRow.appendChild(createSeparator());
                            padsRow.appendChild(createRgbButton(i , j));
                        }
                    }   
                    uiWrapper.appendChild(padsRow); 
                }
            }

            document.addEventListener("DOMContentLoaded", () => {
                build_ui();
                setInterval(() => {
                    socket.emit('getNewDisplayImage');
                }, 500);
            });

        </script>
    </head>
    <body>
        <h1>push2-python simulator</h1>
        <div id="display"><img id="displayImg" /></div>
        <div id="uiWrapper"></div>
    </body>
</html>